@page
@model Web.IdP.Pages.Connect.AuthorizeModel
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Authorize Application"];
}

<div class="container">
    <div class="row justify-content-center mt-5">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-body p-4">
                    <h2 class="card-title text-center mb-4">@ViewData["Title"]</h2>
                    
                    <div class="alert alert-info" role="alert">
                        <strong>@Model.ApplicationName</strong> @Localizer["is requesting access to your account"]
                    </div>

                    @if (Model.ScopeInfos.Any())
                    {
                        <div class="mb-4">
                            <h5>@Localizer["This application will be able to:"]</h5>
                            
                            @* Group scopes by category *@
                            @{
                                var groupedScopes = Model.ScopeInfos.GroupBy(s => s.Category ?? "General").OrderBy(g => g.Key);
                            }
                            
                            @foreach (var group in groupedScopes)
                            {
                                @if (groupedScopes.Count() > 1 && !string.IsNullOrEmpty(group.Key))
                                {
                                    <h6 class="mt-3 mb-2 text-muted">@group.Key</h6>
                                }
                                
                                <div class="mb-3">
                                    @foreach (var scopeInfo in group)
                                    {
                                        <div class="form-check mb-2">
                                            <input 
                                                class="form-check-input" 
                                                type="checkbox" 
                                                name="granted_scopes" 
                                                value="@scopeInfo.Name" 
                                                id="scope_@scopeInfo.Name"
                                                checked
                                                @if (scopeInfo.IsRequired) { <text>disabled</text> }
                                            />
                                            <label class="form-check-label d-flex align-items-start" for="scope_@scopeInfo.Name">
                                                <div class="flex-grow-1">
                                                    <div class="d-flex align-items-center">
                                                        @* Display icon if provided *@
                                                        @if (!string.IsNullOrEmpty(scopeInfo.IconUrl))
                                                        {
                                                            @if (scopeInfo.IconUrl.StartsWith("bi "))
                                                            {
                                                                <i class="@scopeInfo.IconUrl me-2"></i>
                                                            }
                                                            else
                                                            {
                                                                <img src="@scopeInfo.IconUrl" alt="@scopeInfo.Name" class="me-2" style="width: 20px; height: 20px;" />
                                                            }
                                                        }
                                                        else
                                                        {
                                                            @* Default icons for standard scopes *@
                                                            @if (scopeInfo.Name == "openid")
                                                            {
                                                                <i class="bi bi-person-badge me-2"></i>
                                                            }
                                                            else if (scopeInfo.Name == "email")
                                                            {
                                                                <i class="bi bi-envelope me-2"></i>
                                                            }
                                                            else if (scopeInfo.Name == "profile")
                                                            {
                                                                <i class="bi bi-person me-2"></i>
                                                            }
                                                            else if (scopeInfo.Name == "roles")
                                                            {
                                                                <i class="bi bi-shield-check me-2"></i>
                                                            }
                                                            else
                                                            {
                                                                <i class="bi bi-check-circle me-2"></i>
                                                            }
                                                        }
                                                        
                                                        <div>
                                                            <strong>
                                                                @* Use ConsentDisplayName if available, otherwise fallback to DisplayName or Name *@
                                                                @(scopeInfo.ConsentDisplayName ?? scopeInfo.DisplayName)
                                                            </strong>
                                                            
                                                            @if (scopeInfo.IsRequired)
                                                            {
                                                                <span class="badge bg-warning text-dark ms-2">@Localizer["Required"]</span>
                                                            }
                                                        </div>
                                                    </div>
                                                    
                                                    @* Display description if provided *@
                                                    @if (!string.IsNullOrEmpty(scopeInfo.ConsentDescription))
                                                    {
                                                        <div class="text-muted small mt-1">
                                                            @scopeInfo.ConsentDescription
                                                        </div>
                                                    }
                                                </div>
                                            </label>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }

                    <form method="post">
                        @* Preserve original authorize request parameters in the POST body *@
                        @foreach (var kvp in Request.Query)
                        {
                            foreach (var val in kvp.Value)
                            {
                                <input type="hidden" name="@kvp.Key" value="@val" />
                            }
                        }
                        <div class="d-grid gap-2">
                            <button type="submit" name="submit" value="allow" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle"></i> @Localizer["Allow Access"]
                            </button>
                            <button type="submit" name="submit" value="deny" class="btn btn-danger">
                                <i class="bi bi-x-circle"></i> @Localizer["Deny"]
                            </button>
                        </div>
                    </form>

                    <div class="text-center mt-3">
                        <small class="text-muted">
                            @Localizer["By allowing access, you agree to share the requested information with this application."]
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
